<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tr·∫°ng th√°i giao th√¥ng ‚Äî Google Maps (Realtime)</title>
  <style>
    /* --- Reset + c∆° b·∫£n --- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial
    }

    html,
    body,
    #app {
      height: 100%
    }

    body {
      background: #f4f6f8;
      color: #111
    }

    /* --- Layout: sidebar + map --- */
    .app {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 360px;
      max-width: 45%;
      min-width: 260px;
      background: #fff;
      border-right: 1px solid #e6e9ee;
      padding: 16px;
      overflow: auto;
      box-shadow: 0 0 12px rgba(15, 20, 30, 0.04);
    }

    .map-wrap {
      flex: 1;
      position: relative;
    }

    #map {
      position: absolute;
      inset: 0;
      border-left: 1px solid #e6e9ee
    }

    /* --- Controls --- */
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px
    }

    .btn {
      background: #0b63d7;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(11, 99, 215, 0.12);
    }

    .btn.ghost {
      background: #fff;
      color: #0b63d7;
      border: 1px solid #dbe9ff;
      box-shadow: none
    }

    .small {
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 6px
    }

    /* --- Incident list --- */
    .incident {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #f1f3f6;
      margin-bottom: 8px;
      display: flex;
      gap: 10px;
      align-items: flex-start
    }

    .sev {
      width: 10px;
      height: 10px;
      border-radius: 50%
    }

    .sev.low {
      background: #2ecc71
    }

    .sev.med {
      background: #f1c40f
    }

    .sev.high {
      background: #e74c3c
    }

    .inc-body {
      flex: 1
    }

    .inc-title {
      font-weight: 700;
      margin-bottom: 6px
    }

    .inc-time {
      font-size: 12px;
      color: #667085
    }

    .etc-support {
  background: #f7f9fc;
  padding: 60px 20px;
  font-family: Inter, sans-serif;
}

.etc-container {
  max-width: 1200px;
  margin: auto;
}

.etc-support h2 {
  font-size: 32px;
  margin-bottom: 8px;
  font-weight: 700;
  color: #1a2b48;
}

.etc-subtitle {
  color: #566;
  margin-bottom: 30px;
}

.etc-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 22px;
}

.etc-card {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.06);
  border-left: 5px solid #1e88e5;
  transition: 0.25s;
}

.etc-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 30px rgba(0,0,0,0.1);
}

.etc-card h3 {
  margin-bottom: 12px;
  color: #1e3a5f;
}

.etc-card ul {
  list-style: disc;
  padding-left: 20px;
  margin-bottom: 14px;
}

.etc-btn {
  margin-top: 8px;
  padding: 10px 14px;
  border: none;
  background: #1e88e5;
  color: #fff;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.25s;
  display: inline-block;
}

.etc-btn:hover {
  background: #0d6cd4;
}

#etc-search {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccd;
  border-radius: 8px;
  margin-bottom: 10px;
}

.etc-result {
  margin-top: 12px;
  background: #eef4ff;
  padding: 12px;
  border-radius: 8px;
  display: none;
}

.etc-contact {
  margin-top: 40px;
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.07);
}


    /* --- Responsive --- */
    @media (max-width:800px) {
      .sidebar {
        position: absolute;
        z-index: 20;
        left: 8px;
        top: 8px;
        max-width: calc(100% - 16px);
        width: auto;
        height: auto;
        box-shadow: 0 8px 24px rgba(10, 20, 40, 0.16)
      }

      .map-wrap {
        padding-top: 0
      }
    }
  </style>
</head>

<body>
  <section class="etc-support">
  <div class="etc-container">
    <h2>H·ªó tr·ª£ thu ph√≠ t·ª± ƒë·ªông (ETC)</h2>
    <p class="etc-subtitle">H∆∞·ªõng d·∫´n ƒëƒÉng k√Ω, ki·ªÉm tra t√†i kho·∫£n v√† x·ª≠ l√Ω c√°c l·ªói th∆∞·ªùng g·∫∑p.</p>

    <!-- Cards -->
    <div class="etc-grid">
      
      <!-- Card 1: ETC l√† g√¨ -->
      <div class="etc-card">
        <h3>ETC l√† g√¨?</h3>
        <p>
          ETC (Electronic Toll Collection) l√† h·ªá th·ªëng thu ph√≠ t·ª± ƒë·ªông kh√¥ng d·ª´ng, 
          gi√∫p xe qua tr·∫°m nhanh h∆°n, gi·∫£m √πn t·∫Øc v√† t·ª± ƒë·ªông tr·ª´ ti·ªÅn trong t√†i kho·∫£n.
        </p>
      </div>

      <!-- Card 2: H∆∞·ªõng d·∫´n ƒëƒÉng k√Ω -->
      <div class="etc-card">
        <h3>H∆∞·ªõng d·∫´n ƒëƒÉng k√Ω</h3>
        <ul>
          <li>Chu·∫©n b·ªã CMND/CCCD + gi·∫•y ƒëƒÉng k√Ω xe</li>
          <li>Ch·ªçn nh√† cung c·∫•p: VETC ho·∫∑c ePass</li>
          <li>D√°n th·∫ª t·∫°i ƒëi·ªÉm d·ªãch v·ª• ho·∫∑c ƒëƒÉng k√Ω online</li>
        </ul>
        <button class="etc-btn">ƒêƒÉng k√Ω VETC</button>
        <button class="etc-btn">ƒêƒÉng k√Ω ePass</button>
      </div>

      <!-- Card 3: Tra c·ª©u ETC -->
      <div class="etc-card">
        <h3>Ki·ªÉm tra t√†i kho·∫£n ETC</h3>
        <p>Nh·∫≠p bi·ªÉn s·ªë ho·∫∑c s·ªë t√†i kho·∫£n ƒë·ªÉ ki·ªÉm tra s·ªë d∆∞.</p>
        <input type="text" id="etc-search" placeholder="Nh·∫≠p bi·ªÉn s·ªë (VD: 51H-123.45)">
        <button class="etc-btn" onclick="checkETC()">Tra c·ª©u</button>
        <div id="etc-result" class="etc-result"></div>
      </div>

      <!-- Card 4: L·ªói th∆∞·ªùng g·∫∑p -->
      <div class="etc-card">
        <h3>L·ªói th∆∞·ªùng g·∫∑p</h3>
        <ul>
          <li>Th·∫ª ETC kh√¥ng ƒë∆∞·ª£c nh·∫≠n di·ªán</li>
          <li>Kh√¥ng tr·ª´ ti·ªÅn khi qua tr·∫°m</li>
          <li>T√†i kho·∫£n s·∫Øp h·∫øt ti·ªÅn</li>
          <li>Th·∫ª ETC b·ªã bong / m·ªù</li>
        </ul>
      </div>

    </div>

    <!-- Contact -->
    <div class="etc-contact">
      <h3>Li√™n h·ªá h·ªó tr·ª£</h3>
      <p>üìû VETC: <strong>1900 6010</strong></p>
      <p>üìû ePass: <strong>1900 1023</strong></p>
    </div>

  </div>
</section>

  </div>

  <script>
    // ==============================
    // C·∫§U H√åNH: Thay YOUR_GOOGLE_MAPS_API_KEY
    // ==============================
  </script>

  <!-- Google Maps JS (callback initMap) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap" async
    defer></script>

  <script>
    // ---- Globals ----
    let map;
    let trafficLayer;
    let markers = new Map(); // id -> google.maps.Marker
    let autoRefreshTimer = null;
    let currentCenter = { lat: 10.762622, lng: 106.660172 }; // fallback: HCMC
    const INCIDENT_API = '/api/incidents'; // thay b·∫±ng endpoint th·∫≠t c·ªßa b·∫°n

    // helper: format time
    function fmtTime(ts) {
      const d = new Date(ts);
      return d.toLocaleString('vi-VN', { hour12: false });
    }

    // initMap: callback c·ªßa Google Maps
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: currentCenter,
        zoom: 12,
        streetViewControl: false,
        mapTypeControl: false,
      });

      // Traffic layer
      trafficLayer = new google.maps.TrafficLayer();
      trafficLayer.setMap(map); // b·∫≠t m·∫∑c ƒë·ªãnh

      // UI controls
      document.getElementById('btn-toggle-traffic').addEventListener('click', toggleTraffic);
      document.getElementById('btn-refresh').addEventListener('click', fetchIncidents);
      document.getElementById('btn-center').addEventListener('click', locateUser);

      const sel = document.getElementById('refresh-interval');
      sel.addEventListener('change', () => {
        startAutoRefresh(parseInt(sel.value, 10));
      });

      // ƒë·ªãnh v·ªã ng∆∞·ªùi d√πng n·∫øu cho ph√©p
      locateUser();

      // l·∫ßn g·ªçi ƒë·∫ßu
      fetchIncidents();

      // start auto refresh m·∫∑c ƒë·ªãnh theo select
      startAutoRefresh(parseInt(sel.value, 10));
    }

    // Toggle Traffic layer visibility
    function toggleTraffic() {
      const btn = document.getElementById('btn-toggle-traffic');
      if (trafficLayer.getMap()) {
        trafficLayer.setMap(null);
        btn.textContent = 'B·∫≠t Traffic';
        btn.classList.remove('btn'); btn.classList.add('btn', 'ghost');
      } else {
        trafficLayer.setMap(map);
        btn.textContent = 'T·∫Øt Traffic';
        btn.classList.remove('btn', 'ghost'); btn.classList.add('btn');
      }
    }

    // Locate user (geolocation)
    function locateUser() {
      if (!navigator.geolocation) {
        alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation.');
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.panTo(p);
        map.setZoom(13);
        // add a temporary marker
        new google.maps.Marker({ position: p, map, title: 'B·∫°n ƒëang ·ªü ƒë√¢y' });
      }, err => {
        console.warn('Geolocation error', err);
      }, { enableHighAccuracy: true, maximumAge: 60_000 });
    }

    // Start / stop auto-refresh
    function startAutoRefresh(ms) {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
      }
      if (ms > 0) {
        autoRefreshTimer = setInterval(fetchIncidents, ms);
      }
    }

    // Fetch incidents from API; fallback to sample data if API fails
    async function fetchIncidents() {
      let incidents;
      try {
        const res = await fetch(INCIDENT_API, { cache: "no-store" });
        if (!res.ok) throw new Error('No data from API');
        incidents = await res.json();
      } catch (e) {
        // fallback sample (simulate)
        incidents = sampleIncidents();
        console.info('Using fallback incidents', e);
      }
      // normalize and render
      if (!Array.isArray(incidents)) incidents = [];
      updateIncidents(incidents);
    }

    // Update markers and sidebar from incidents array
    function updateIncidents(incidents) {
      const listEl = document.getElementById('incidents-list');

      // Markers: keep ones with same id, remove missing
      const incomingIds = new Set(incidents.map(i => String(i.id)));
      // remove markers that are no longer present
      for (const id of Array.from(markers.keys())) {
        if (!incomingIds.has(id)) {
          markers.get(id).setMap(null);
          markers.delete(id);
        }
      }

      listEl.innerHTML = '';
      incidents.forEach(inc => {
        const id = String(inc.id);
        // Add/Update marker
        if (!markers.has(id)) {
          const marker = new google.maps.Marker({
            position: { lat: inc.lat, lng: inc.lng },
            map,
            title: inc.title,
            icon: markerIconBySeverity(inc.severity),
          });

          const info = new google.maps.InfoWindow({
            content: `<strong>${escapeHtml(inc.title)}</strong><div style="font-size:13px;margin-top:6px">${escapeHtml(inc.description || '')}</div><div style="font-size:12px;color:#666;margin-top:6px">${fmtTime(inc.time)}</div>`
          });
          marker.addListener('click', () => info.open(map, marker));
          markers.set(id, marker);
        } else {
          // update position/icon if needed
          const marker = markers.get(id);
          const pos = marker.getPosition();
          if (pos.lat() !== inc.lat || pos.lng() !== inc.lng) {
            marker.setPosition({ lat: inc.lat, lng: inc.lng });
          }
          marker.setIcon(markerIconBySeverity(inc.severity));
        }

        // Add to sidebar
        const el = document.createElement('div');
        el.className = 'incident';
        el.innerHTML = `
          <div class="sev ${sevClass(inc.severity)}" aria-hidden="true"></div>
          <div class="inc-body">
            <div class="inc-title">${escapeHtml(inc.title)}</div>
            <div class="inc-time">${fmtTime(inc.time)} ‚Ä¢ ${escapeHtml(inc.location || '')}</div>
            <div style="margin-top:6px;color:#374151;font-size:13px">${escapeHtml(inc.description || '')}</div>
          </div>
        `;
        el.addEventListener('click', () => {
          const m = markers.get(id);
          if (m) {
            map.panTo(m.getPosition());
            map.setZoom(15);
            new google.maps.InfoWindow({ content: `<strong>${escapeHtml(inc.title)}</strong><div style="font-size:13px;margin-top:6px">${escapeHtml(inc.description || '')}</div>` }).open(map, m);
          }
        });
        listEl.appendChild(el);
      });
    }

    // Helper: small icon by severity
    function markerIconBySeverity(sev) {
      // Simple colored circle SVG data URL
      const color = sev === 'high' ? '#e74c3c' : (sev === 'med' ? '#f1c40f' : '#2ecc71');
      const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28'><circle cx='14' cy='14' r='10' fill='${color}' stroke='#fff' stroke-width='2'/></svg>`);
      return { url: `data:image/svg+xml;charset=UTF-8,${svg}`, scaledSize: new google.maps.Size(28, 28) };
    }

    function sevClass(sev) {
      if (sev === 'high') return 'high';
      if (sev === 'med') return 'med';
      return 'low';
    }

    // XSS safe small escaper
    function escapeHtml(s) {
      if (!s && s !== 0) return '';
      return String(s).replace(/[&<>"'`=\/]/g, function (c) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', "/": '&#x2F;', '`': '&#x60;', '=': '&#x3D;' }[c];
      });
    }

    // Fallback sample incidents (simulate server)
    function sampleIncidents() {
      const now = Date.now();
      return [
        { id: '1', lat: 10.7628, lng: 106.6829, title: 'T·∫Øc do tai n·∫°n', description: 'Va ch·∫°m 2 xe, ƒëang x·ª≠ l√Ω', severity: 'high', time: now - 5 * 60 * 1000, location: 'C·∫ßu S√†i G√≤n' },
        { id: '2', lat: 10.7765, lng: 106.7006, title: '√ôn t·∫Øc nh·∫π', description: 'M·∫≠t ƒë·ªô cao', severity: 'med', time: now - 12 * 60 * 1000, location: 'ƒê∆∞·ªùng Mai Ch√≠ Th·ªç' },
        { id: '3', lat: 10.7590, lng: 106.6620, title: 'Thi c√¥ng', description: 'ƒêang thi c√¥ng m·ªü r·ªông', severity: 'low', time: now - 40 * 60 * 1000, location: 'Xa l·ªô H√† N·ªôi' },
      ];
    }

    // Start by deferring fetchIncidents until maps loaded (initMap will call)
    // If you want WebSocket real-time: create ws = new WebSocket('wss://...'); ws.onmessage => updateIncidents([...])

    // Optional: if page is left idle, stop auto refresh to save resources
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        if (autoRefreshTimer) clearInterval(autoRefreshTimer);
      } else {
        const sel = document.getElementById('refresh-interval');
        startAutoRefresh(parseInt(sel.value, 10));
      }
    });
  </script>
</body>

</html>